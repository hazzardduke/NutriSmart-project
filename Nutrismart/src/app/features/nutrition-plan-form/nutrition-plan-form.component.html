<div class="nutrition-plan-container">
  <div class="nutrition-plan-card">
    <h2 class="card-title">Planes Nutricionales</h2>

    <!-- Tabs -->
    <div class="tabs">
      <button [class.active]="currentTab==='create'" (click)="setTab('create')">
        Nuevo Plan
      </button>
      <button [class.active]="currentTab==='history'" (click)="setTab('history')">
        Histórico
      </button>
    </div>

    <!-- NUEVO PLAN -->
    <section *ngIf="currentTab==='create'" class="create-tab">
      <div class="client-select relative">
        <label for="clientSearch">Buscar Cliente</label>
        <input
          id="clientSearch"
          type="text"
          class="input"
          placeholder="Escribe un nombre o cédula..."
          [(ngModel)]="searchTerm"
          (focus)="onSearchFocus()"
          (input)="onSearchChange()"
          autocomplete="off"
        />
        <ul *ngIf="filteredClients.length > 0" class="dropdown-results">
          <li
            *ngFor="let c of filteredClients"
            (click)="selectClient(c)"
            class="dropdown-item"
            [class.selected]="selectedClient?.id === c.id"
          >
            {{ c.nombre }} {{ c.apellido }} ({{ c.cedula }})
          </li>
        </ul>
      </div>

      <p *ngIf="!selectedClient" class="no-data">
        Selecciona un cliente para crear un plan nutricional.
      </p>

      <form *ngIf="selectedClient" [formGroup]="portionsForm">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>Alimentos</th>
                <th>Porciones</th>
                <th>Desayuno</th>
                <th>Mer#1</th>
                <th>Almu</th>
                <th>Mer#2</th>
                <th>Cena</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let cat of categories" [formGroupName]="cat">
                <td>{{ cat }}</td>
                <td>{{ computePorciones(cat) }}</td>
                <td>
                  <select formControlName="desayuno">
                    <option *ngFor="let n of numbers" [value]="n">{{ n }}</option>
                  </select>
                </td>
                <td>
                  <select formControlName="merienda1">
                    <option *ngFor="let n of numbers" [value]="n">{{ n }}</option>
                  </select>
                </td>
                <td>
                  <select formControlName="almuerzo">
                    <option *ngFor="let n of numbers" [value]="n">{{ n }}</option>
                  </select>
                </td>
                <td>
                  <select formControlName="merienda2">
                    <option *ngFor="let n of numbers" [value]="n">{{ n }}</option>
                  </select>
                </td>
                <td>
                  <select formControlName="cena">
                    <option *ngFor="let n of numbers" [value]="n">{{ n }}</option>
                  </select>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <button
          type="button"
          class="btn-submit"
          (click)="onExportTablaYRecomendaciones()"
        >
          Guardar Plan & Descargar PDF
        </button>
      </form>
    </section>

    <!-- HISTÓRICO -->
    <section *ngIf="currentTab==='history'" class="history-tab">
      <div class="client-select relative">
        <label for="filterClient">Filtrar Cliente</label>
        <input
          id="filterClient"
          type="text"
          class="input"
          placeholder="Escribe un nombre o cédula..."
          [(ngModel)]="searchTerm"
          (focus)="onSearchFocus()"
          (input)="onSearchChange()"
          autocomplete="off"
        />
        <ul *ngIf="filteredClients.length > 0" class="dropdown-results">
          <li
            class="dropdown-item"
            [class.selected]="!selectedClient"
            (click)="clearClientSelection(); filterControl.setValue('')"
          >
            Ver todos los clientes
          </li>
          <li
            *ngFor="let c of filteredClients"
            (click)="filterControl.setValue(c.id); selectClient(c)"
            class="dropdown-item"
            [class.selected]="selectedClient?.id === c.id"
          >
            {{ c.nombre }} {{ c.apellido }} ({{ c.cedula }})
          </li>
        </ul>
      </div>

      <ng-container *ngIf="filteredPlans$ | async as plans">
        <ng-container *ngIf="plans.length > 0; else noPlans">
          <table class="history-table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of plans">
                <td>{{ p.client.name }}</td>
                <td>{{ p.client.date }}</td>
                <td class="actions">
                  <button
                    class="btn-action btn-view"
                    (click)="openModal(p)"
                  >
                    Mostrar Tabla
                  </button>
                  <button
                    class="btn-action btn-download"
                    (click)="downloadPdf(p)"
                  >
                    Descargar PDF
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </ng-container>
      </ng-container>

      <ng-template #noPlans>
        <div class="no-plans">
          No hay planes para el cliente seleccionado
        </div>
      </ng-template>
    </section>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" *ngIf="modalPlan as mp">
  <div class="modal">
    <div class="modal-header">
      <h3>
        Plan de {{ mp.client.name }} – {{ mp.client.cedula }} – {{ mp.client.date }}
      </h3>
      <button class="close-btn" (click)="closeModal()">×</button>
    </div>
    <div class="table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>Alimentos</th>
            <th>Porciones</th>
            <th>Desayuno</th>
            <th>Mer#1</th>
            <th>Almu</th>
            <th>Mer#2</th>
            <th>Cena</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let cat of categories">
            <td>{{ cat }}</td>
            <td>
              {{
                mp.portions[cat].desayuno +
                mp.portions[cat].merienda1 +
                mp.portions[cat].almuerzo +
                mp.portions[cat].merienda2 +
                mp.portions[cat].cena
              }}
            </td>
            <td>{{ mp.portions[cat].desayuno }}</td>
            <td>{{ mp.portions[cat].merienda1 }}</td>
            <td>{{ mp.portions[cat].almuerzo }}</td>
            <td>{{ mp.portions[cat].merienda2 }}</td>
            <td>{{ mp.portions[cat].cena }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
