<!-- src/app/features/nutrition-plan-form/nutrition-plan-form.component.html -->
<div class="nutrition-plan-container">
  <div class="nutrition-plan-card">
    <h2 class="card-title">Planes Nutricionales</h2>

    <div class="tabs">
      <button
        [class.active]="currentTab==='create'"
        (click)="setTab('create')">
        Nuevo Plan
      </button>
      <button
        [class.active]="currentTab==='history'"
        (click)="setTab('history')">
        Histórico
      </button>
    </div>

    <!-- NUEVO PLAN -->
    <section *ngIf="currentTab==='create'" class="create-tab">
      <div class="client-select">
        <label for="client">Cliente</label>
        <select
          #clientSelect
          id="client"
          (change)="onClientSelect(clientSelect)">
          <option value="" disabled selected>-- Seleccione cliente --</option>
          <option *ngFor="let c of clients" [value]="c.id">
            {{ c.cedula }} – {{ c.nombre }} {{ c.apellido }}
          </option>
        </select>
      </div>

      <form *ngIf="selectedClient" [formGroup]="portionsForm">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>Alimentos</th>
                <th>Porciones</th>
                <th>Desayuno</th>
                <th>Mer#1</th>
                <th>Almu</th>
                <th>Mer#2</th>
                <th>Cena</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let cat of categories" [formGroupName]="cat">
                <td>{{ cat }}</td>
                <td>{{ computePorciones(cat) }}</td>
                <td>
                  <select formControlName="desayuno">
                    <option *ngFor="let n of numbers" [value]="n">{{ n }}</option>
                  </select>
                </td>
                <td>
                  <select formControlName="merienda1">
                    <option *ngFor="let n of numbers" [value]="n">{{ n }}</option>
                  </select>
                </td>
                <td>
                  <select formControlName="almuerzo">
                    <option *ngFor="let n of numbers" [value]="n">{{ n }}</option>
                  </select>
                </td>
                <td>
                  <select formControlName="merienda2">
                    <option *ngFor="let n of numbers" [value]="n">{{ n }}</option>
                  </select>
                </td>
                <td>
                  <select formControlName="cena">
                    <option *ngFor="let n of numbers" [value]="n">{{ n }}</option>
                  </select>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button type="button" class="btn-submit" (click)="onExportTablaYRecomendaciones()">
          Guardar Plan & Descargar PDF
        </button>
      </form>
    </section>

    <!-- HISTÓRICO -->
    <section *ngIf="currentTab==='history'" class="history-tab">
      <div class="client-select">
        <label for="filterClient">Filtrar Cliente</label>
        <select [formControl]="filterControl" id="filterClient">
          <option value="">Todos</option>
          <option *ngFor="let c of clients" [value]="c.id">
            {{ c.cedula }} – {{ c.nombre }} {{ c.apellido }}
          </option>
        </select>
      </div>

      <!-- 1. Guardamos el async en 'plans' -->
      <ng-container *ngIf="filteredPlans$ | async as plans">
        <!-- 2. Solo mostramos la tabla si plans.length > 0 -->
        <ng-container *ngIf="plans.length > 0; else noPlans">
          <table class="history-table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Creado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of plans">
                <!-- ahora solo mostramos el nombre -->
                <td>{{ p.client.name }}</td>
                <td>{{ p.client.date }}</td>
                <td>{{ p.createdAt?.toDate() | date:'short' }}</td>
                <td class="actions">
                  <button class="btn-action" (click)="openModal(p)">Mostrar Tabla</button>
                  <button class="btn-action" (click)="downloadPdf(p)">Descargar PDF</button>
                </td>
              </tr>
            </tbody>
          </table>
        </ng-container>
      </ng-container>

      <ng-template #noPlans>
        <div class="no-plans">No hay planes para el cliente seleccionado</div>
      </ng-template>
    </section>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" *ngIf="modalPlan as mp">
  <div class="modal">
    <div class="modal-header">
      <h3>
        Plan de {{ mp.client.name }}
        – {{ mp.client.cedula }}
        – {{ mp.client.date }}
      </h3>
      <button class="close-btn" (click)="closeModal()">×</button>
    </div>
    <div class="table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>Alimentos</th>
            <th>Porciones</th>
            <th>Desayuno</th>
            <th>Mer#1</th>
            <th>Almu</th>
            <th>Mer#2</th>
            <th>Cena</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let cat of categories">
            <td>{{ cat }}</td>
            <td>
              {{
                mp.portions[cat].desayuno
                + mp.portions[cat].merienda1
                + mp.portions[cat].almuerzo
                + mp.portions[cat].merienda2
                + mp.portions[cat].cena
              }}
            </td>
            <td>{{ mp.portions[cat].desayuno }}</td>
            <td>{{ mp.portions[cat].merienda1 }}</td>
            <td>{{ mp.portions[cat].almuerzo }}</td>
            <td>{{ mp.portions[cat].merienda2 }}</td>
            <td>{{ mp.portions[cat].cena }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
