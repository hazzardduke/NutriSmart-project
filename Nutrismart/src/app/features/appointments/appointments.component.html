<div class="citas-container">
  <h2 class="titulo-citas">
    <i class="fas fa-calendar-alt"></i> Gestión de Citas
  </h2>

  <form (ngSubmit)="guardarCita()" class="form-cita">
    <div class="form-group">
      <label for="fecha">Fecha</label>
      <input
        type="date"
        id="fecha"
        [(ngModel)]="fechaSeleccionada"
        name="fecha"
        [min]="today"
        (change)="onFechaChange()"
        required
      />
    </div>

    <div class="form-group">
      <label>Selecciona un horario</label>
      <div class="horarios">
        <button
          *ngFor="let h of horarios"
          type="button"
          class="btn-horario"
          [class.selected]="h === horaSeleccionada"
          [disabled]="!isHorarioDisponible(h)"
          (click)="horaSeleccionada = h"
        >
          {{ h }}
        </button>
      </div>
    </div>

    <div class="acciones">
      <button
        type="submit"
        class="btn-accion confirm"
        [disabled]="!horaSeleccionada"
      >
        {{ enEdicion ? 'Actualizar Cita' : 'Programar Cita' }}
      </button>

      <button
        *ngIf="enEdicion"
        type="button"
        class="btn-accion cancel"
        (click)="cancelarEdicion()"
      >
        Cancelar Edición
      </button>
    </div>
  </form>

  <div class="nota">
    <strong>Nota:</strong> Puede editar o cancelar su cita hasta 24 horas antes.
  </div>

  <div *ngIf="citasUsuario.length > 0" class="lista-citas">
    <h3 class="subtitulo">Mis Citas</h3>

    <table class="tabla-citas">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr
          *ngFor="let c of citasPaginadas"
          [ngClass]="{
            'fila-proxima': esProximaCita(c),
            'fila-pasada': esCitaPasada(c) || c.status === 'canceled'
          }"
        >
          <td>
            {{ formateaFecha(c.datetime) }}
            <div *ngIf="esProximaCita(c)" class="proxima-etiqueta">
             Próxima cita
            </div>
          </td>

          <td>{{ formateaHora(c.datetime) }}</td>

          <td>
            <span
              [ngClass]="{
                'estado-confirmed': c.status === 'confirmed',
                'estado-completed': c.status === 'completed',
                'estado-canceled': c.status === 'canceled'
              }"
            >
              {{
                c.status === 'confirmed'
                  ? 'Confirmada'
                  : c.status === 'completed'
                  ? 'Completada'
                  : 'Cancelada'
              }}
            </span>
          </td>

          <td>
            <button
              *ngIf="c.status === 'confirmed' && puedeCancelar(c)"
              class="btn-editar"
              (click)="editarCita(c)"
            >
              Editar
            </button>

            <button
              *ngIf="c.status === 'confirmed' && puedeCancelar(c)"
              class="btn-cancelar"
              (click)="cancelarCitaEspecifica(c)"
            >
              Cancelar
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="paginacion">
      <button (click)="cambiarPagina(-1)" [disabled]="paginaActual === 1">
        Anterior
      </button>

      <button *ngIf="hayBloqueAnterior()" (click)="irABloqueAnterior()">...</button>

      <ng-container *ngFor="let p of paginasVisibles">
        <button
          (click)="irAPagina(p)"
          [class.pagina-activa]="paginaActual === p"
        >
          {{ p }}
        </button>
      </ng-container>

      <button *ngIf="hayBloqueSiguiente()" (click)="irABloqueSiguiente()">...</button>

      <button
        (click)="cambiarPagina(1)"
        [disabled]="paginaActual === totalPaginas()"
      >
        Siguiente
      </button>
    </div>
  </div>

  <div *ngIf="citasUsuario.length === 0" class="no-citas">
    <p>No tienes citas programadas actualmente.</p>
  </div>
</div>
