<div class="container p-4">
  <h1 class="text-2xl font-bold mb-4">Gestión de Objetivos Nutricionales</h1>
  <hr /><br />

  <div class="client-select">
    <label for="client">Cliente</label>
    <select id="client" class="input" [(ngModel)]="selectedClientUid" (change)="onClientSelect()" name="client" required>
      <option [ngValue]="null" disabled>-- Seleccionar cliente --</option>
      <option *ngFor="let c of clients" [ngValue]="c.uid">{{ c.nombre }} {{ c.apellidos }} ({{ c.cedula }})</option>
    </select> 
  </div>

  <div *ngIf="selectedClientUid">
    <form (ngSubmit)="guardarObjetivo()" class="form-section">
      <div class="objetivo">
        <h2 class="section-title">Definir Objetivo Nutricional</h2>
        <div>
          <label for="tipo">Tipo de Objetivo</label>
          <select id="tipo" class="input" [(ngModel)]="nuevoObjetivo.tipo" name="tipo" required>
            <option value="" disabled>-- Seleccionar --</option>
            <option>Pérdida de peso</option>
            <option>Ganancia muscular</option>
            <option>Aumentar porcentaje de agua</option>
            <option>Mantenimiento</option>
            <option>Reducir porcentaje de grasa</option>
            <option>Otro</option>
          </select>
        </div>
        <div>
          <label for="meta">Meta (porcentaje o cantidad)</label>
          <input id="meta" class="input" [(ngModel)]="nuevoObjetivo.meta" name="meta" required />
        </div>
        <div>
          <label for="meses">Meses Estimados</label>
          <select id="meses" class="input" [(ngModel)]="nuevoObjetivo.meses" name="meses" required>
            <option [ngValue]="null" disabled>-- Seleccionar meses --</option>
            <option *ngFor="let m of mesesOptions" [ngValue]="m">{{ m }}</option>
          </select>
        </div>
        <button type="submit" class="btn-save">Guardar Objetivo</button>
      </div>
    </form>

    <div class="popup" *ngIf="showPopup">
      <div class="popup-content">{{ mensajeService }}<button class="close-btn" (click)="showPopup=false">×</button></div>
    </div>
    <hr /><br />

    <div class="form-section">
      <div class="objetivo">
        <h2 class="section-title">Mis Objetivos</h2>
        <div class="tabs">
          <button [class.active]="tabInterno==='objetivos'" (click)="tabInterno='objetivos'">Objetivos</button>
          <button [class.active]="tabInterno==='recomendaciones'" (click)="tabInterno='recomendaciones'">Recomendaciones</button>
        </div>

        <div *ngIf="tabInterno==='objetivos'">
          <div class="objetivo" *ngFor="let obj of objetivos">
            <h4>{{ obj.tipo }}</h4>
            <p>{{ obj.meta }}</p>
            <p><strong>Fecha meta:</strong> {{ obj.fecha }}</p>
            <p><strong>Progreso:</strong> {{ obj.progreso }}%</p>
            <div class="progreso-input">
              <label for="progreso-{{ obj.id }}">Progreso (%)</label>
              <input type="number" id="progreso-{{ obj.id }}" [(ngModel)]="progresoTemp[obj.id!]" name="progreso-{{ obj.id }}" min="0" max="100" step="1" class="input-progreso" />
              <button class="btn-action" (click)="actualizarProgreso(obj)">Actualizar</button>
            </div>
            <div class="progress-wrapper">
              <div class="progress-bar" [style.width.%]="obj.progreso"></div>
              <div class="thumb" [style.left.%]="obj.progreso"></div>
              <span class="progress-text">{{ obj.progreso }}%</span>
            </div>
            <button class="btn-action" (click)="eliminarObjetivo(obj)">Completar</button>
          </div>
        </div>

        <div *ngIf="tabInterno==='recomendaciones'">
          <div class="recomendacion" *ngFor="let rec of recomendaciones">
            <p><strong>{{ rec.fecha }}</strong>: {{ rec.resumen }}</p>
            <button class="btn btn-sm btn-primary" (click)="abrirModal(rec)">Ver Detalles</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-bg" *ngIf="selectedRecomendacion">
      <div class="detalles">
        <h4>Recomendación del {{ selectedRecomendacion.fecha }}</h4>
        <p>{{ selectedRecomendacion.comentario }}</p>
        <button class="btn btn-danger mt-3" (click)="cerrarModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
