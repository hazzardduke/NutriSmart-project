<div class="goals-container">
  <h1>Gestión de Objetivos Nutricionales</h1>


  <div class="tab-bar">
    <button [class.active]="tabPrincipal === 'crear'" (click)="switchPrincipal('crear')">Crear</button>
    <button [class.active]="tabPrincipal === 'objetivos'" (click)="switchPrincipal('objetivos')">Objetivos</button>
    <button [class.active]="tabPrincipal === 'historico'" (click)="switchPrincipal('historico')">Histórico</button>
  </div>


  <ng-container *ngIf="tabPrincipal === 'crear'">
    <div class="client-section autocomplete">
      <label for="clientSearchCrear">Buscar Cliente</label>
      <input
        id="clientSearchCrear"
        type="text"
        class="input"
        placeholder="Escribe un nombre o cédula..."
        [(ngModel)]="searchTerm"
        (focus)="onSearchFocus()"
        (input)="onSearchChange()"
        autocomplete="off"
      />

      <ul *ngIf="filteredClients.length > 0" class="dropdown-results" (mousedown)="$event.stopPropagation()">
        <li
          *ngFor="let c of filteredClients"
          (click)="selectClient(c.uid)"
          [class.selected]="selectedClientUid === c.uid"
        >
          {{ c.nombre }} {{ c.apellidos }} ({{ c.cedula }})
        </li>
      </ul>
    </div>

    <div *ngIf="!selectedClientUid" class="no-data">
      Selecciona un cliente para crear un objetivo.
    </div>

    <form *ngIf="selectedClientUid" (ngSubmit)="guardarObjetivo()" class="card-centered">
      <h2>Definir Objetivo Nutricional</h2>

      <div class="form-group">
        <label for="tipo">Tipo de Objetivo</label>
        <select id="tipo" class="input" [(ngModel)]="nuevoObjetivo.tipo" name="tipo" required>
          <option value="" disabled selected>-- Seleccionar --</option>
          <option>Pérdida de peso</option>
          <option>Ganancia muscular</option>
          <option>Aumentar porcentaje de agua</option>
          <option>Mantenimiento</option>
          <option>Reducir porcentaje de grasa</option>
          <option>Otro</option>
        </select>
      </div>

      <div class="form-group">
        <label for="meta">Meta (porcentaje o cantidad)</label>
        <input id="meta" class="input" [(ngModel)]="nuevoObjetivo.meta" name="meta" required />
      </div>

      <div class="form-group">
        <label for="meses">Meses Estimados</label>
        <select id="meses" class="input" [(ngModel)]="nuevoObjetivo.meses" name="meses" required>
          <option value="" disabled selected>-- Seleccionar meses --</option>
          <option *ngFor="let m of mesesOptions" [ngValue]="m">{{ m }}</option>
        </select>
      </div>

      <button type="submit" class="btn-primary">Guardar Objetivo</button>
    </form>
  </ng-container>


  <ng-container *ngIf="tabPrincipal === 'objetivos'">
    <div class="client-section autocomplete">
      <label for="clientSearchObj">Buscar Cliente</label>
      <input
        id="clientSearchObj"
        type="text"
        class="input"
        placeholder="Escribe un nombre o cédula..."
        [(ngModel)]="searchTerm"
        (focus)="onSearchFocus()"
        (input)="onSearchChange()"
        autocomplete="off"
      />

      <ul *ngIf="filteredClients.length > 0" class="dropdown-results" (mousedown)="$event.stopPropagation()">
        <li
          *ngFor="let c of filteredClients"
          (click)="selectClient(c.uid)"
          [class.selected]="selectedClientUid === c.uid"
        >
          {{ c.nombre }} {{ c.apellidos }} ({{ c.cedula }})
        </li>
      </ul>
    </div>

    <div *ngIf="!selectedClientUid" class="no-data">Selecciona un cliente para ver objetivos.</div>

    <div *ngIf="selectedClientUid" class="card-centered">
      <h2>Objetivos en Progreso</h2>

      <div *ngIf="paginatedObjetivos.length === 0" class="no-data">
        No hay objetivos en progreso.
      </div>

      <div *ngFor="let obj of paginatedObjetivos" class="goal-card-centered">
        <div class="goal-header">
          <div class="goal-info">
            <h3>{{ obj.tipo }}</h3>
            <p><strong>Meta:</strong> {{ obj.meta }}</p>
            <p><strong>Fecha meta:</strong> {{ obj.fecha | date: 'dd-MM-yyyy' }}</p>
          </div>

          <div class="goal-actions">
            <button (click)="openRecModal(obj)">Ver Recomendaciones</button>
          </div>
        </div>

        <div class="progress-section">
          <label>Progreso (%)</label>
          <div class="progress-actions">
            <input
              type="number"
              class="input small"
              [(ngModel)]="progresoTemp[obj.id!]"
              min="0"
              max="100"
            />
            <button
              *ngIf="progresoTemp[obj.id!] < 100"
              class="btn-gray"
              (click)="updateProgreso(obj)"
            >
              Actualizar
            </button>
            <button
              *ngIf="progresoTemp[obj.id!] >= 100"
              class="btn-green"
              (click)="confirmarCompletar(obj)"
            >
              Completar
            </button>
          </div>

          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="obj.progreso"></div>
            <span class="progress-text">{{ obj.progreso }}%</span>
          </div>
        </div>
      </div>

      <div class="pagination">
        <button (click)="prevPageObj()" [disabled]="currentPageObj === 1">Anterior</button>
        <button
          *ngFor="let page of totalPagesArrayObj"
          (click)="goToPageObj(page)"
          [class.active]="page === currentPageObj"
        >
          {{ page }}
        </button>
        <button (click)="nextPageObj()" [disabled]="currentPageObj === totalPagesObj">Siguiente</button>
      </div>
    </div>
  </ng-container>


  <ng-container *ngIf="tabPrincipal === 'historico'">
    <div class="client-section autocomplete">
      <label for="clientSearchHist">Buscar Cliente</label>
      <input
        id="clientSearchHist"
        type="text"
        class="input"
        placeholder="Escribe un nombre o cédula..."
        [(ngModel)]="searchTerm"
        (focus)="onSearchFocus()"
        (input)="onSearchChange()"
        autocomplete="off"
      />

      <ul *ngIf="filteredClients.length > 0" class="dropdown-results" (mousedown)="$event.stopPropagation()">
        <li
          *ngFor="let c of filteredClients"
          (click)="selectClient(c.uid)"
          [class.selected]="selectedClientUid === c.uid"
        >
          {{ c.nombre }} {{ c.apellidos }} ({{ c.cedula }})
        </li>
      </ul>
    </div>

    <div *ngIf="!selectedClientUid" class="no-data">
      Selecciona un cliente para ver su histórico.
    </div>

    <div *ngIf="selectedClientUid" class="card-centered">
      <h2>Histórico de Objetivos Completados</h2>

      <div *ngIf="paginatedHistorico.length === 0" class="no-data">
        No hay objetivos completados.
      </div>

      <div *ngFor="let h of paginatedHistorico" class="goal-card-centered" style="border-left-color:#28a745;">
        <div class="goal-header">
          <div class="goal-info">
            <h3>{{ h.tipo }}</h3>
            <p><strong>Meta:</strong> {{ h.meta }}</p>
            <p><strong>Fecha completado:</strong> {{ h.fecha | date: 'dd-MM-yyyy' }}</p>
          </div>
          <div class="goal-actions">
            <button (click)="openRecModal(h)">Ver Recomendaciones</button>
          </div>
        </div>
      </div>

      <div class="pagination">
        <button (click)="prevPageHist()" [disabled]="currentPageHist === 1">Anterior</button>
        <button
          *ngFor="let page of totalPagesArrayHist"
          (click)="goToPageHist(page)"
          [class.active]="page === currentPageHist"
        >
          {{ page }}
        </button>
        <button (click)="nextPageHist()" [disabled]="currentPageHist === totalPagesHist">Siguiente</button>
      </div>
    </div>
  </ng-container>


  <div class="modal-bg" *ngIf="showRecModal">
    <div class="modal" [class.edit-mode]="showInputRec">
      <h3 *ngIf="!showInputRec">Recomendaciones para {{ recModalGoal.tipo }}</h3>
      <h3 *ngIf="showInputRec">Nueva recomendación para {{ recModalGoal.tipo }}</h3>

      <ng-container *ngIf="!showInputRec; else addRecTemplate">
        <div *ngIf="paginatedRecs.length === 0" class="no-data">
          No hay recomendaciones registradas.
        </div>


        <ul class="rec-list" *ngIf="paginatedRecs.length > 0">
          <li
            *ngFor="let r of paginatedRecs; let i = index"
            class="animate-item"
            [style.animationDelay]="(i * 0.08) + 's'"
          >
            <span>{{ r.comentario }}</span>
            <small>{{ r.fecha | date: 'dd/MM/yyyy' }}</small>
          </li>
        </ul>

        <div class="pagination small" *ngIf="totalPagesRecs > 1">
          <button (click)="prevPageRecs()" [disabled]="currentPageRecs === 1">Anterior</button>
          <span>Página {{ currentPageRecs }} / {{ totalPagesRecs }}</span>
          <button (click)="nextPageRecs()" [disabled]="currentPageRecs === totalPagesRecs">Siguiente</button>
        </div>

        <div class="modal-actions">
          <button *ngIf="tabPrincipal !== 'historico'" class="btn-2" (click)="showInputRec = true">
            Agregar nueva recomendación
          </button>
          <button class="btn-cancel" (click)="showRecModal = false">Cerrar</button>
        </div>
      </ng-container>


      <ng-template #addRecTemplate>
        <div class="add-rec-section">
          <textarea
            class="input"
            rows="3"
            placeholder="Escribe una nueva recomendación..."
            [(ngModel)]="newComentario"
          ></textarea>

          <div class="modal-actions">
            <button class="btn-primary" (click)="saveRecomendacion()">Guardar</button>
            <button class="btn-cancel" (click)="cancelAddRec()">Cancelar</button>
          </div>
        </div>
      </ng-template>
    </div>
  </div>
</div>
